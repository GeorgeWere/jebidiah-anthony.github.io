<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    
    
    
    <meta property="og:title" content="Windows Event Collector" />
    
    

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Windows Event Collector | jebidiah-anthony</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Windows Event Collector" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="write-ups and what not" />
<meta property="og:description" content="write-ups and what not" />
<link rel="canonical" href="http://localhost:4000/prjct/Windows-Event-Collector.html" />
<meta property="og:url" content="http://localhost:4000/prjct/Windows-Event-Collector.html" />
<meta property="og:site_name" content="jebidiah-anthony" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/prjct/Windows-Event-Collector.html","headline":"Windows Event Collector","description":"write-ups and what not","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <h1>jebidiah-anthony</h1>
        <h2>write-ups and what not</h2>

	<span>
	  <a href="/">whoami</a> | 
          <a href="/htb.html">htb writeups</a> | 
	  <a href="/ctf.html">ctf writeups</a> | 
	  <a href="/projects.html">projects</a> 
	</span>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="setting-up-a-windows-event-collector">Setting up a Windows Event Collector</h1>

<h2 id="environment"><strong>ENVIRONMENT:</strong></h2>

<h4 id="machines">MACHINES:</h4>

<table>
  <thead>
    <tr>
      <th>HOSTNAME</th>
      <th>MACHINE IP</th>
      <th>OS</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>MSEDGEWIN10</td>
      <td>192.168.150.128</td>
      <td>Windows 10 Enterprise Evaluation</td>
      <td>Source Machine</td>
    </tr>
    <tr>
      <td>WIN-BO2CT95INDP</td>
      <td>192.168.150.133</td>
      <td>Windows Server 2016</td>
      <td>Collector Machine</td>
    </tr>
  </tbody>
</table>

<p><strong>NOTE(S)</strong>:</p>
<ul>
  <li>The FQDN for WIN-BO2CT95INDP is <strong>win-bo2ct95indp.bossmanben.local</strong></li>
</ul>

<hr />

<h2 id="assumptions"><strong>ASSUMPTIONS:</strong></h2>

<h3 id="i--the-source-machine-msedgewin10-is-part-of-a-domain-controller-win-bo2ct95indp">i.  The Source Machine (MSEDGEWIN10) is part of a Domain Controller (WIN-BO2CT95INDP).</h3>

<h3 id="ii-this-guide-uses-security-logs-as-an-example">ii. This guide uses <strong><em>Security Logs</em></strong> as an example.</h3>

<hr />

<h2 id="procedure"><strong>PROCEDURE:</strong></h2>

<p><strong>NOTE(S)</strong>:</p>
<ul>
  <li>The steps below will create a subscription that collects <strong><em>Security logs</em></strong> from the <strong>Source Machine</strong> (MSEDGEWIN10)</li>
</ul>

<h3 id="i-start-the-winrm-service"><strong>i. Start the WinRM service</strong></h3>

<ol>
  <li>Open <strong>PowerShell</strong> on the Source Machine (MSEDGEWIN10):
    <pre><code class="language-ps1">winrm quickconfig
</code></pre>
    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li>Add the Collector Machine to the Source Machine’s trustedhosts:
        <pre><code class="language-ps1">Set-Item wsman:localhost/client/trustedhosts 192.168.150.133
</code></pre>
      </li>
      <li>Restart the service for changes to take effect:
        <pre><code class="language-ps1">Restart-Service WinRM
</code></pre>
      </li>
    </ul>
  </li>
  <li>Check if the service is running:
    <pre><code class="language-ps1">winrm get winrm/config
</code></pre>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
        AllowRemoteAccess = true
    Winrs
        AllowRemoteShellAccess = true
...omitted...
</code></pre></div>    </div>
    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li><code class="highlighter-rouge">AllowRemoteAccess = true</code> signifies that the service is running.</li>
    </ul>
  </li>
  <li>Test if the Collector Machine (BOSSMANBEN) is reachable using WinRM:
    <pre><code class="language-ps1">Test-WSMan WIN-BO2CT95INDP
</code></pre>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wsmid           : http://schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd
ProtocolVersion : http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd
ProductVendor   : Microsoft Corporation
ProductVersion  : OS: 0.0.0 SP: 0.0 Stack: 3.0
</code></pre></div>    </div>
    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li>WinRM is <strong>enabled by default</strong> on Windows Server 2012 and up.</li>
      <li>This is just a measure to check if the Collector Machine is indeed reachable.</li>
    </ul>
  </li>
</ol>

<h3 id="ii-add-the-collector-machine-to-the-event-log-readers-groups"><strong>ii. Add the Collector Machine to the Event Log Readers groups</strong></h3>

<ul>
  <li>
    <p><strong>In the Source Machine (MSEDGEWIN10):</strong></p>

    <ol>
      <li>
        <p>Open the <strong>Local Users and Groups</strong>:</p>

        <ul>
          <li>Press <code class="highlighter-rouge">Win</code> + <code class="highlighter-rouge">R</code> then enter <code class="highlighter-rouge">lusrmgr.msc</code></li>
        </ul>
      </li>
      <li>
        <p>Navigate to <code class="highlighter-rouge">Local Users and Groups (Local)</code> <strong>&gt;</strong> <code class="highlighter-rouge">Groups</code>:</p>

        <ol>
          <li>Right-click <code class="highlighter-rouge">Event Log Readers</code> and select <code class="highlighter-rouge">Properties</code></li>
          <li>Select <code class="highlighter-rouge">Add...</code></li>
        </ol>
      </li>
      <li>
        <p>Select <code class="highlighter-rouge">Object Types...</code> then check the box, <code class="highlighter-rouge">Computers</code></p>
      </li>
      <li>
        <p><code class="highlighter-rouge">Enter the object names to select</code> – “<strong><em>WIN-BO2CT95INDP</em></strong>”</p>

        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>Select <code class="highlighter-rouge">Check Names</code> for good measure.</li>
        </ul>
      </li>
      <li>
        <p>Select <code class="highlighter-rouge">OK</code> when done.</p>
      </li>
    </ol>
  </li>
</ul>

<h3 id="iii-create-subscriptions-using-event-viewer"><strong>iii. Create Subscriptions using Event Viewer</strong></h3>

<ul>
  <li>
    <p><strong>In the Collector Machine (WIN-BO2CT95INDP):</strong></p>

    <ol>
      <li>
        <p>Open the <strong>Event Viewer</strong>:</p>

        <ul>
          <li>Press <code class="highlighter-rouge">Win</code> + <code class="highlighter-rouge">R</code> then enter gpedit <code class="highlighter-rouge">eventvwr.msc</code></li>
        </ul>
      </li>
      <li>
        <p>On the left panel, right-click on <code class="highlighter-rouge">Subscriptions</code> then select <code class="highlighter-rouge">Create Subscription...</code></p>

        <ol>
          <li>
            <p><code class="highlighter-rouge">Subscription Name</code> – “<strong><em>Remote Security Logs</em></strong>”</p>
          </li>
          <li>
            <p><code class="highlighter-rouge">Description</code> – “<strong><em>Security Logs from the Domain Computer, MSEDGEWIN10</em></strong>”</p>
          </li>
          <li>
            <p><code class="highlighter-rouge">Destination log</code> – “<strong><em>Forwarded Events</em></strong>”</p>

            <p><strong>NOTE(S)</strong>:</p>
            <ul>
              <li>Custom logs could be created but <code class="highlighter-rouge">Forwarded Events</code> is selected by default.</li>
              <li>Click <a href="./Custom-evtx-Logfiles.html">here</a> to create custom logs.</li>
            </ul>
          </li>
          <li>
            <p>Select <code class="highlighter-rouge">Subscription type and source computers</code>:</p>

            <ul>
              <li>
                <p>If you choose <code class="highlighter-rouge">Collector initiated</code> then select <code class="highlighter-rouge">Select Computers...</code>:</p>

                <ol>
                  <li>Select <code class="highlighter-rouge">Add Domain Computers...</code></li>
                  <li><code class="highlighter-rouge">Enter the object name to select</code> – “<strong><em>MSEDGEWIN10</em></strong>”</li>
                  <li>Select <code class="highlighter-rouge">Check Names</code> for good measure.</li>
                  <li>Select <code class="highlighter-rouge">OK</code></li>
                  <li>Select <code class="highlighter-rouge">Test</code> for good measure.</li>
                  <li>Select <code class="highlighter-rouge">OK</code></li>
                </ol>
              </li>
              <li>
                <p>If you choose <code class="highlighter-rouge">Source initiated</code> then select <code class="highlighter-rouge">Select Computer Groups...</code>:</p>

                <ol>
                  <li>Select <code class="highlighter-rouge">Add Domain Computers...</code></li>
                  <li><code class="highlighter-rouge">Enter the object name to select</code> – “<strong><em>MSEDGEWIN10</em></strong>”</li>
                  <li>Select <code class="highlighter-rouge">Check Names</code> for good measure.</li>
                  <li>Select <code class="highlighter-rouge">OK</code></li>
                  <li>Select <code class="highlighter-rouge">Test</code> for good measure.</li>
                  <li>Select <code class="highlighter-rouge">OK</code></li>
                </ol>

                <ul>
                  <li>
                    <p>On the Source Machine (MSEDGEWIN10):</p>

                    <ol>
                      <li>
                        <p>Press <code class="highlighter-rouge">Win</code> + <code class="highlighter-rouge">R</code> then enter <code class="highlighter-rouge">gpedit.msc</code></p>

                        <ol>
                          <li>Navigate to <code class="highlighter-rouge">Computer Management</code> <strong>&gt;</strong> <code class="highlighter-rouge">Administrative Templates</code> <strong>&gt;</strong> <code class="highlighter-rouge">Windows Components</code> <strong>&gt;</strong> <code class="highlighter-rouge">Event Forwarding</code></li>
                          <li>Right-click on <code class="highlighter-rouge">Configure target Subscription Manager</code> then select <code class="highlighter-rouge">Edit</code></li>
                          <li>Choose <code class="highlighter-rouge">Enabled</code></li>
                          <li>Under <code class="highlighter-rouge">Options</code>, beside <code class="highlighter-rouge">SubscriptionManagers</code>, press <code class="highlighter-rouge">Show...</code></li>
                          <li>Enter <code class="highlighter-rouge">Server=http://win-bo2ct95indp.bossmanben.local:5985/wsman/SubscriptionManager/WEC,Refresh=30</code></li>
                          <li>Press <code class="highlighter-rouge">OK</code></li>
                          <li>Press <code class="highlighter-rouge">OK</code></li>
                        </ol>
                      </li>
                      <li>
                        <p>Open <strong>PowerShell</strong> or <strong>cmd</strong> the run <code class="highlighter-rouge">gpupdate /force</code></p>
                      </li>
                    </ol>
                  </li>
                  <li>
                    <p>On the Collector Machine (WIN-BO2CT95INDP):</p>

                    <ol>
                      <li>Open <strong>PowerShell</strong> or <strong>cmd</strong> then run <code class="highlighter-rouge">wecutil quick-config</code></li>
                    </ol>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <p>Select <code class="highlighter-rouge">Select Events...</code>:</p>

            <ol>
              <li><code class="highlighter-rouge">Logged</code> – “<strong><em>Any time</em></strong>”</li>
              <li><code class="highlighter-rouge">Event level</code> – <strong><em>Critical</em></strong>, <strong><em>Error</em></strong>, <strong><em>Information</em></strong>, <strong><em>Warning</em></strong></li>
              <li>Choose <code class="highlighter-rouge">By log</code> – <strong><em>Windows</em></strong> -&gt; <strong><em>Security</em></strong></li>
              <li>Filter <strong>Event IDs</strong> – 4624,4657,4688,4698,4720,4722,4724,4732,4738,4769</li>
              <li>Select <code class="highlighter-rouge">OK</code></li>
            </ol>
          </li>
          <li>
            <p>Select <code class="highlighter-rouge">Advanced...</code>:</p>

            <ol>
              <li><code class="highlighter-rouge">User Account</code> – Choose <code class="highlighter-rouge">Machine Account</code></li>
              <li><code class="highlighter-rouge">Event Delivery Optimization</code> – Choose <code class="highlighter-rouge">Minimize Latency</code></li>
              <li>Select <code class="highlighter-rouge">OK</code></li>
            </ol>

            <p><strong>NOTE(S)</strong>:</p>
            <ul>
              <li>
                <p>There are three <code class="highlighter-rouge">Event Delivery Optimization</code> options:</p>

                <table>
                  <thead>
                    <tr>
                      <th>OPTION</th>
                      <th>DESCRIPTION</th>
                      <th>INTERVAL</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Normal</td>
                      <td>Does not conserve bandwidth</td>
                      <td>15 minutes via pull delivery</td>
                    </tr>
                    <tr>
                      <td>Minimize Bandwidth</td>
                      <td>Bandwidth for delivery is controlled</td>
                      <td>6 hours via push delivery</td>
                    </tr>
                    <tr>
                      <td>Minimize Latency</td>
                      <td>Delivery with minimal delay</td>
                      <td>30 seconds via push delivery</td>
                    </tr>
                  </tbody>
                </table>
              </li>
            </ul>
          </li>
          <li>
            <p>Select <code class="highlighter-rouge">OK</code></p>
          </li>
        </ol>
      </li>
      <li>
        <p>Right-click on the newly created subscription then select <code class="highlighter-rouge">Runtime Status</code>:</p>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MSEDGEWIN10.bossmanben.local] - Error - Last retry time: 7/17/2019 8:27:52 PM. 
Code (0x138C): &lt;f:ProviderFault provider="Event Forwarding Plugin" path="C:\Windows\system32\wevtfwd.dll" 
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p><strong>In the Source Machine (WIN-BO2CT95INDP):</strong></p>

    <ol>
      <li>Run <code class="highlighter-rouge">wevtutil</code>:
        <pre><code class="language-ps1">wevtutil get-log Security
</code></pre>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name: Security
enabled: true
type: Admin
owningPublisher:
isolation: Custom
channelAccess: O:BAG:SYD:(A;;0xf0005;;;SY)(A;;0x5;;;BA)(A;;0x1;;;S-1-5-32-573)
logging:
  logFileName: %SystemRoot%\System32\Winevt\Logs\Security.evtx
  retention: false
  autoBackup: false
  maxSize: 20971520
publishing:
  fileMax: 1
</code></pre></div>        </div>
      </li>
      <li>Add the <strong>Network Service Account</strong> (S-1-5-20) to the <code class="highlighter-rouge">channelAccess</code> field:
        <pre><code class="language-ps1">wevtutil set-log Security /ca:"O:BAG:SYD:(A;;0xf0005;;;SY)(A;;0x5;;;BA)(A;;0x1;;;S-1-5-32-573)(A;;0x1;;;S-1-5-20)"
</code></pre>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>WinRM runs under the <strong><em>Network Service Account</em></strong> which had no access to the <strong>Security Logs</strong></li>
        </ul>
      </li>
    </ol>
  </li>
  <li>
    <p><strong>Going back to the Collector Machine (WIN-BO2CT95INDP):</strong></p>

    <ol>
      <li>
        <p>Go to the <strong>Event Viewer</strong>:</p>

        <ul>
          <li>Press <code class="highlighter-rouge">Win</code> + <code class="highlighter-rouge">R</code> then enter gpedit <code class="highlighter-rouge">eventvwr.msc</code></li>
        </ul>
      </li>
      <li>
        <p>On the left panel, go to <code class="highlighter-rouge">Subscriptions</code> then select the recently created subscription</p>
      </li>
      <li>
        <p>On the right panel, under the <strong><em>subscription name</em></strong>, select <code class="highlighter-rouge">Retry</code></p>
      </li>
      <li>
        <p>Right-click on the recently created subscription then select <code class="highlighter-rouge">Runtime Status</code>:</p>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MSEDGEWIN10.bossmanben.local] - Active - : No additional status.
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>An Event with <strong>ID 100 (Name=”SubscribeSuccess”)</strong> will appear on <strong><em>Microsoft-Windows-Event-ForwardPlugin/Operational</em></strong> in the Source Machine (MSEDGEWIN10)</li>
        </ul>
      </li>
    </ol>
  </li>
</ul>

<h3 id="iv-wait-for-logs-to-be-sent-to-the-forwarded-events-logs"><strong>iv. Wait for logs to be sent to the Forwarded Events logs</strong></h3>

<p><strong>NOTE(S)</strong>:</p>
<ul>
  <li>TImestamps are preserved</li>
  <li>Log contents are preserved</li>
</ul>

<hr />

<h2 id="references"><strong>REFERENCES:</strong></h2>
<ul>
  <li>https://www.vkernel.ro/blog/how-to-configure-windows-event-log-forwarding?fbclid=IwAR1bQ9VpgL–PWaqvEWcJBduR3xJ2UnBBhZmO7UGef-NXcKN9PCINZ3gmQ0</li>
  <li>https://www.itprotoday.com/strategy/q-what-are-some-simple-tips-testing-and-troubleshooting-windows-event-forwarding-and?fbclid=IwAR3ceGoJU-jgkD2U_rVo2FmQee5M0spvE85lZRVw0FHv4YFTphLaX-5JJe8</li>
  <li>https://rockyprogress.wordpress.com/2011/12/04/security-event-log-collection-from-a-domain-controller/?fbclid=IwAR01Puy9Wvr4eCQeV828raqfLesYJwVTw_8EAmDgvJIKYBVWoaT3giv24PA</li>
  <li>https://blogs.technet.microsoft.com/supportingwindows/2016/07/18/setting-up-a-source-initiated-subscription-on-an-event-collector-computer/?fbclid=IwAR2JagIePrComWaIcZknK_92Igakb4_jvnrmJJnGpZlFGnms_2PM7z6trJc</li>
</ul>

      </section>
    </div>

    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'true', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
